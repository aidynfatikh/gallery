<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gallery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-img-top { height: 200px; object-fit: cover; }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content bg-dark">
                    <div class="modal-body p-0 position-relative">
                        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-2" data-bs-dismiss="modal"></button>
                        <img id="modalImage" src="" class="w-100" style="object-fit: contain; max-height: 90vh;">
                    </div>
                </div>
            </div>
        </div>
        
        <h1 class="text-center mb-5">Gallery</h1>
        
        <div class="row mb-4 justify-content-center">
            <div class="col-md-5 mb-2">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="input-group">
                        <input type="file" name="images" class="form-control" accept="image/*" multiple required>
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                </form>
            </div>
            <div class="col-md-5 mb-2">
                <form id="searchForm" enctype="multipart/form-data">
                    <div class="input-group">
                        <input type="file" name="image" class="form-control" accept="image/*" required>
                        <button type="submit" class="btn btn-secondary">Search</button>
                    </div>
                </form>
            </div>
        </div>

        <form id="generateForm" class="mb-4 d-flex align-items-center">
            <div class="input-group">
                <input type="text" name="prompt" class="form-control" placeholder="Enter prompt…" required>
                <button id="generateBtn" type="submit" class="btn btn-primary">Generate</button>
            </div>
            <div id="generateSpinner" class="spinner-border text-primary ms-3" role="status" style="display: none; width:1.5rem; height:1.5rem;">
                <span class="visually-hidden">Loading…</span>
            </div>
        </form>
        
        <div id="gallery" class="row g-4"></div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function getCSRFToken() {
            const m = document.cookie.match(/csrftoken=([^;]+)/);
            return m ? m[1] : '';
        }

        function attachImageClickHandlers() {
            document.querySelectorAll('.clickable-img').forEach(img => {
                img.onclick = () => {
                    document.getElementById('modalImage').src = img.dataset.url;
                    new bootstrap.Modal(document.getElementById('imageModal')).show();
                };
            });
        }

        window.onload = loadGallery;
        async function loadGallery() {
            const images = await (await fetch('/images/')).json();
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            const uploaded = images.filter(i => !i.is_generated);
            const generated = images.filter(i => i.is_generated);

            if (uploaded.length) {
                gallery.append(createSection('Uploaded Images', uploaded));
            }
            if (generated.length) {
                const spacer = document.createElement('div');
                spacer.className = 'w-100 mt-5';
                gallery.appendChild(spacer);
                gallery.appendChild(createSection('AI‑Generated Images', generated));
            }
            attachImageClickHandlers();
        }

        function createSection(title, images) {
            const frag = document.createDocumentFragment();
            const header = document.createElement('div'); header.className = 'col-12'; header.innerHTML = `<h2 class="text-center">${title}</h2>`;
            frag.append(header);
            const row = document.createElement('div'); row.className = 'row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4 w-100';
            images.forEach(img => row.append(createCard(img)));
            frag.append(row);
            return frag;
        }

        function createCard(image) {
            const col = document.createElement('div'); col.className = 'col';
            col.innerHTML = `
                <div class="card position-relative">
                    <img src="${image.image_url}" class="card-img-top clickable-img" style="height:200px;object-fit:cover;cursor:pointer;" data-url="${image.image_url}">
                    <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" onclick="deleteImage(${image.id})">×</button>
                    <div class="card-body"><p class="card-text"><small>${new Date(image.uploaded_at).toLocaleString()}</small></p></div>
                </div>`;
            return col;
        }

        async function deleteImage(id) {
            await fetch(`/delete/${id}/`, { 
                method: 'DELETE', 
                headers: {'X-CSRFToken': getCSRFToken()} });
            loadGallery();
        }

        document.getElementById('generateForm').onsubmit = async function(e) {
            e.preventDefault(); 
            const btn = document.getElementById('generateBtn');
            const spinner = document.getElementById('generateSpinner');
            const prompt = this.prompt.value.trim(); 
            if(!prompt) return;

            btn.disabled = true; spinner.style.display = '';
            await fetch('/generate-image/', { 
                method: 'POST', 
                headers: {'Content-Type':'application/json','X-CSRFToken':getCSRFToken()}, 
                body: JSON.stringify({prompt}) 
            });
            spinner.style.display='none'; btn.disabled=false; loadGallery();
        };

        document.getElementById('uploadForm').onsubmit = async function(e) {
            e.preventDefault(); 
            for(const f of this.images.files) { const fd=new FormData(); fd.append('image',f); 
            await fetch('/upload/', {
                method: 'POST',
                body:fd }
            );}
            this.reset(); loadGallery();
        };

        document.getElementById('searchForm').onsubmit = async function(e) {
            e.preventDefault();
            const res = await fetch('/search-image/',{method:'POST',body:new FormData(this)});
            if (!res.ok) { console.error('Search failed:', await res.text()); return; }
            const imgs = await res.json();
            const gallery=document.getElementById('gallery'); gallery.innerHTML='';
            const up=imgs.filter(i=>!i.is_generated), gen=imgs.filter(i=>i.is_generated);
            if (up.length) gallery.append(createSection('Uploaded (by similarity)', up));
            if (gen.length) { const spacer=document.createElement('div'); spacer.className='w-100 mt-5'; gallery.appendChild(spacer); gallery.append(createSection('AI‑Generated (by similarity)', gen)); }
            attachImageClickHandlers();
        };
    </script>
</body>
</html>